{% extends "base.html" %}

{% block content %}
    <div x-data="container" @keydown="onKeyDown($event)" tabindex="0">
        <h1>{{ set.name }}</h1>
        <p>Description: {{ set.description }}</p>
        <p>Created at: {{ set.created_at }}</p>

        <div>
            <div @mousedown.prevent="onKeyDown($event)" @contextmenu.prevent>
                <div x-show="index < images.length">
                    <p :style="{ visibility: showLabel ? 'visible' : 'hidden' }" x-text="label"></p>
                    <img x-ref="image" :src="image" height="300">
                </div>
                <div x-show="index >= images.length">
                    <h2>Set completed!</h2>
                    <p>You got <span x-text="correct"></span> out of <span x-text="images.length"></span> correct.</p>
                    <a href="">Try again</a>
                </div>
            </div>
            <button @click="nextImage(1)"><i class="fas fa-check"></i></button>
            <button @click="turn()"><i class="fas fa-rotate-left"></i></button>
            {% if current_user.is_authenticated %}
                <button @click="know()" title="Click this if you are already sure with this, so we won't show you this image anymore."><i class="fas fa-lightbulb"></i></button>
            {% endif %}
            <button @click="nextImage(0)"><i class="fas fa-times"></i></button>

            <label for="mouse_controls">Enable mouse controls</label>
            <input type="checkbox" id="mouse_controls" x-model="mouseControls">

            <label for="keyboard_controls">Enable keyboard controls</label>
            <input type="checkbox" id="keyboard_controls" x-model="keyboardControls">
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('container', () => ({
                index: 0,
                image: '',
                label: '',
                images: JSON.parse('{{ set.images|tojson }}'),
                correct: 0,
                showLabel: false,
                mouseControls: true,
                keyboardControls: true,

                init() {
                    this.shuffle(this.images);
                    this.loadImage();
                },

                shuffle(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                },

                async loadImage() {
                    this.image = `/api/sets/{{ set.id }}/image/${this.images[this.index].id}`;
                    this.label = this.images[this.index].label;
                },

                nextImage(correct) {
                    this.correct += correct;
                    this.index += 1;
                    this.showLabel = false;
                    this.loadImage();
                },

                turn() {
                    this.showLabel = !this.showLabel;
                },

                async know() {
                    await axios.post(`/api/sets/{{ set.hash }}/skip`, {
                        image_id: this.images[this.index].id,
                    });

                    this.nextImage(1);
                },

                onKeyDown(event) {
                    if (this.index >= this.images.length) {return;}

                    console.log(event.button, event.key);

                    if (this.mouseControls && event.button !== undefined) {
                        if (this.showLabel) {
                            if (event.button === 2) {
                                this.nextImage(1);
                            } else if (event.button === 0) {
                                this.nextImage(0);
                            } else {
                                this.turn();
                            }
                        } else {
                            this.turn();
                        }
                    } else if (this.keyboardControls && event.key !== undefined) {
                        if (event.key.length > 1) {return;}
                        
                        if (this.showLabel) {
                            if (event.key === 'ArrowRight') {
                                this.nextImage(1);
                            } else if (event.key === 'ArrowLeft') {
                                this.nextImage(0);
                            } else {
                                this.turn();
                            }
                        } else {
                            this.turn();
                        }
                    }

                    event.preventDefault();
                },
            }));
        });
    </script>
{% endblock %}
