
{#
Args:
- set: The set object
#}

{% extends "base.html" %}
{% from 'components/popup_message.html' import message_list %}

{% block content %}
    <div x-data="container" class="container" @keydown="onKeyDown($event)" tabindex="0">
        {% include 'components/navigation.html' %}

        <h2>{{ set.name }}</h2>
        
        {{ message_list(ref="popupMessages") }}

        <main>
            <section class="sidebar">
                <a href="/sets/{{ set.hid() }}">Back to set info</a>
                {% if current_user.is_authenticated and current_user.has_access_to(set.get_draft()) %}
                    <a href="/draft/{{ set.hid() }}">Edit set</a>
                {% endif %}
            </section>

            <section class="main">
                <div class="image-wrapper">
                    <p class="image-label" x-text="(!isEnd() && showLabel) ? label : ''"></p>

                    <div x-show="!isEnd()" class="image-main" @mousedown.prevent="onKeyDown($event)" @contextmenu.prevent>
                        <img x-ref="image" :src="image" height="300">
                    </div>

                    <div x-show="isEnd()" class="image-main set-completed">
                        <h2>Set completed!</h2>
                        <p>You got <span x-text="correct"></span> out of <span x-text="images.length"></span> correct.</p>
                        <a href="">Try again</a>
                    </div>
                </div>

                <div class="controls" x-show="!isEnd()">
                    <button class="btn-primary" @click="turn()"><i class="fas fa-rotate-left"></i></button>
                    {% if current_user.is_authenticated %}
                        <button class="btn-primary" @click="know()" title="Click this if you are already sure with this, so we won't show you this image anymore."><i class="fas fa-lightbulb"></i></button>
                    {% else %}
                        <button class="btn-primary btn-disabled" @click="addMessage('error', 'Please log in to skip known images.')" title="Log in to be able to skip known images."><i class="fas fa-lightbulb"></i></button>
                    {% endif %}

                    <button class="btn-success" @click="nextImage(1)"><i class="fas fa-check"></i></button>
                    <button class="btn-error  " @click="nextImage(0)"><i class="fas fa-times"></i></button>
                </div>

                <div class="controls" x-show="isEnd()">
                    <button class="btn-primary" @click="index = 0; correct = 0; loadImage();"><i class="fas fa-redo"></i></button>
                </div>
            </section>

            <section class="sidebar options">
                <div class="checkbox">
                    <label for="mouse_controls">Enable mouse controls</label>
                    <input type="checkbox" id="mouse_controls" x-model="mouseControls" @change="saveSettings('mouse_controls', mouseControls)">
                </div>

                <div class="checkbox">
                    <label for="keyboard_controls">Enable keyboard controls</label>
                    <input type="checkbox" id="keyboard_controls" x-model="keyboardControls" @change="saveSettings('keyboard_controls', keyboardControls)">
                </div>

                {% if not current_user.is_authenticated %}
                    <p class="info">Log in to save your settings permanently.</p>
                {% endif %}
            </section>
        </main>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('container', () => ({
                index: 0,
                image: '',
                label: '',
                images: JSON.parse('{{ get_data(set.images_for(current_user))|tojson }}'),
                correct: 0,
                showLabel: false,
                mouseControls: '{{ UserSettings.settings(current_user).mouse_controls|int }}' === '1',
                keyboardControls: '{{ UserSettings.settings(current_user).keyboard_controls|int }}' === '1',

                init() {
                    this.shuffle(this.images);
                    this.loadImage();
                },

                isEnd() {return this.index >= this.images.length;},

                shuffle(array) {
                    for (let i = array.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [array[i], array[j]] = [array[j], array[i]];
                    }
                    return array;
                },

                async loadImage() {
                    this.image = `/api/sets/{{ set.hid() }}/image/${this.images[this.index].id}`;
                    this.label = this.images[this.index].label;
                },

                nextImage(correct) {
                    this.correct += correct;
                    this.index += 1;
                    this.showLabel = false;
                    this.loadImage();
                },

                turn() {
                    this.showLabel = !this.showLabel;
                },

                async know() {
                    await axios.post(`/api/sets/{{ set.hid() }}/skip`, {
                        image_id: this.images[this.index].id,
                    });

                    this.nextImage(1);
                },

                onKeyDown(event) {
                    if (this.isEnd()) {return;}

                    console.log(event.button, event.key);

                    if (this.mouseControls && event.button !== undefined) {
                        event.preventDefault();
                        if (this.showLabel) {
                            if (event.button === 2) {
                                this.nextImage(1);
                            } else if (event.button === 0) {
                                this.nextImage(0);
                            } else {
                                this.turn();
                            }
                        } else {
                            this.turn();
                        }
                    } else if (this.keyboardControls && event.key !== undefined) {
                        if (event.key.length > 1) {return;}
                        event.preventDefault();
                        
                        if (this.showLabel) {
                            if (event.key === 'ArrowRight') {
                                this.nextImage(1);
                            } else if (event.key === 'ArrowLeft') {
                                this.nextImage(0);
                            } else {
                                this.turn();
                            }
                        } else {
                            this.turn();
                        }
                    }
                },

                addMessage(type, text, duration = 10) {
                    let id = crypto.randomUUID();
                    this.$dispatch('add-message', { id, type, text, duration: duration * 1000 });
                    return id;
                },

                removeMessage(id) {
                    this.$dispatch('remove-message', { id });
                },

                saveSettings(key, value) {
                    if ('{{ (not current_user.is_authenticated)|int }}' === '1') {return;}

                    axios.post('/api/user/settings', {
                        [key]: value ? 1 : 0,
                    });
                },
            }));
        });
    </script>
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/draft.css') }}">
    <style>
        h2 {
            text-align: center;
        }

        .image-label {
            text-align: center;
            height: 20px;
        }

        .image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;

            & button {padding: 8px 23px;}

            & > :nth-child(2) {
                margin-right: 10px;
            }
        }

        .checkbox {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            user-select: none;
        }

        .sidebar .info {
            color: var(--c-grey3);
            font-style: italic;
        }
    </style>
{% endblock %}

