{% extends "base.html" %}

{% block content %}
    <h1>Create a New Set</h1>
    <div x-data="formHandler" x-init="init()" >
        <div>
            <label for="name">Set title:</label>
            <input type="text" id="name" x-ref="titleInput" x-model="title" x-show="titleEditMode" @blur="saveTitle();" />
            <span x-text="title" x-show="!titleEditMode" @click="titleEditMode = true; $nextTick(() => $refs.titleInput.focus())"></span>
        </div>
    
        <label for="description">Description:</label>
        <textarea id="description" x-model="setDescription" @blur="saveDescription()"></textarea>
    
        <div>
            <p>Add images:</p>
            <label for="images" class="btn">Upload:</label>
            <input type="file" id="images" class="hidden" x-ref="imageInput" multiple @change="addImages($event)" />

            <label for="pres" class="btn">Extract from a presentation:</label>
            <input type="file" id="pres" class="hidden" x-ref="presInput" @change="preparePres($event)" />

            <div x-ref="imageList">
                <template x-for="(image, index) in images" :key="index">
                    <div>
                        <img :src="image.image.src" width="100" />
                        <input type="text" x-model="imageLabels[image.image.hash]" placeholder="Enter image caption" @blur="saveImageLabel(index)" />
                        <button @click="removeImage(index)">Remove</button>
                    </div>
                </template>
            </div>
        </div>
    
        <button @click="submitForm">Create Set</button>
    </div>
{% endblock %}

{% block scripts %}
    <script type="module">
        import { CustomImage } from '{{ url_for("static", filename="js/CustomImage.js") }}';
        window.CustomImage = CustomImage;
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formHandler', () => ({
                title: '{{ draft.name or "Untitled Set" }}',
                setDescription: '{{ draft.description or "" }}',
                titleEditMode: true,
                images: [],
                imageLabels: {},
                labels: [],

                init() {
                    this.$refs.titleInput.focus();
                    this.$refs.imageInput.value = '';
                    this.$refs.presInput.value = '';
                    this.fetchGallery();
                },

                async saveTitle() {
                    this.titleEditMode = false;
                    if (!this.title.trim()) {this.title = 'Untitled Set';}

                    this.title = this.title.trim();
                    const result = await axios.post('/api/draft/{{ draft.id }}/rename', { title: this.title });
                },

                async saveDescription() {
                    const result = await axios.post('/api/draft/{{ draft.id }}/description', { description: this.setDescription });
                },

                async saveImageLabel(index) {
                    const image = this.images[index].image;
                    const label = this.imageLabels[image.hash] || '';
                    await axios.post('/api/draft/{{ draft.id }}/image/' + image.id, { label });
                },

                removeImage(index) {
                    const image = this.images[index].image;
                    if (image && image.hash) {
                        delete this.imageLabels[image.hash];
                    }
                    this.images.splice(index, 1);
                },

                async addImages(event) {
                    const fd = new FormData();
                    const files = event.target.files;
                    let added = 0;

                    for (const file of files) {
                        if (file.size > 10 * 1024 * 1024) {continue;} // 10MB limit
                        fd.append('images', file);

                        const cimg = new window.CustomImage(file);
                        await cimg.ready;

                        if (!this.images.some(existing => existing.image.hash === cimg.hash)) {
                            this.images.push({ image: cimg, slide: "" });
                            this.imageLabels[cimg.hash] = '';
                            added++;
                        }
                    }

                    let ids = await axios.post('/api/draft/{{ draft.id }}/gallery', fd, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    for (let i = 0; i < added; i++) {
                        this.images[this.images.length - added + i - 1].image.id = ids.data.images[i].id;
                    }
                },

                async preparePres(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 50 * 1024 * 1024) {return;} // 50MB limit

                    const formData = new FormData();
                    formData.append('presentation', file);
                    formData.append('draft', '{{ draft.id }}');

                    const results = await axios.post('/api/presentation', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    const images = results.data.images || [];
                    const labels = results.data.labels || [];
                    await this.addToGallery(images, labels);
                },

                async fetchGallery() {
                    const result = await axios.get('/api/draft/{{ draft.id }}/gallery');
                    const images = result.data.images || [];
                    const labels = result.data.labels || [];
                    await this.addToGallery(images, labels);
                },

                async addToGallery(images, labels = []) {
                    // Process all images in parallel instead of sequentially
                    const imagePromises = images.map(async (imageData) => {
                        const cimg = new window.CustomImage('/api/draft/{{ draft.id }}/image/' + imageData.filename, null, imageData);
                        await cimg.ready;
                        return { cimg, imageData };
                    });
                    
                    const imageResults = await Promise.all(imagePromises);
                    
                    for (const { cimg, imageData } of imageResults) {
                        if (!this.images.some(existing => existing.image.hash === cimg.hash)) {
                            this.images.push({ image: cimg, slide: imageData.slide });
                            this.imageLabels[cimg.hash] = imageData.label || '';
                        }
                    }

                    for (const labelData of labels) {
                        this.labels.push({ label: labelData.text, slide: labelData.slide });
                    }
                },

                submitForm(event) {
                    if (event) event.preventDefault();

                    console.log({
                        title: this.title,
                        description: this.setDescription,
                        images: this.images.map(img => ({...img.data(), label: this.imageLabels[img.hash]}))
                    });
                    alert('Form submitted successfully!');
                }
            }));
        });
    </script>
{% endblock %}
